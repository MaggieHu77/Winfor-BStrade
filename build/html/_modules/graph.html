
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_cn">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>graph &#8212; BStrade beta v0.7.1 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>graph 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="c1"># ! python3</span>

<span class="kn">from</span> <span class="nn">hlPoint</span> <span class="k">import</span> <span class="n">HLPoint</span>
<span class="kn">from</span> <span class="nn">trend</span> <span class="k">import</span> <span class="n">Trend</span><span class="p">,</span> <span class="n">TrendError</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">DatetimeIndex</span><span class="p">,</span> <span class="n">to_datetime</span><span class="p">,</span> <span class="n">MultiIndex</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">localtime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="k">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">matplotlib.dates</span> <span class="k">import</span> <span class="n">AutoDateLocator</span><span class="p">,</span> <span class="n">DateFormatter</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">from</span> <span class="nn">loadData</span> <span class="k">import</span> <span class="n">loaddataError</span><span class="p">,</span> <span class="n">loadData_daily</span> <span class="k">as</span> <span class="n">ldd</span>
<span class="kn">from</span> <span class="nn">WindPy</span> <span class="k">import</span> <span class="n">w</span>
<span class="kn">import</span> <span class="nn">constant</span>
<span class="kn">from</span> <span class="nn">trade</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">global_backtest</span> <span class="k">import</span> <span class="n">GlobalBacktest</span>
<span class="kn">from</span> <span class="nn">misc</span> <span class="k">import</span> <span class="n">read_file</span>


<div class="viewcode-block" id="BSgraph"><a class="viewcode-back" href="../graph.html#graph.BSgraph">[文档]</a><span class="k">class</span> <span class="nc">BSgraph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_env</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        策略绘图对象的创建函数</span>
<span class="sd">        :param trade_env: 交易环境操作对象</span>
<span class="sd">        :param codename: 股票代码</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span> <span class="o">=</span> <span class="n">trade_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">stat</span>

<div class="viewcode-block" id="BSgraph.wrapper_to_global_backtest"><a class="viewcode-back" href="../graph.html#graph.BSgraph.wrapper_to_global_backtest">[文档]</a>    <span class="k">def</span> <span class="nf">wrapper_to_global_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stock_code</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">code</span><span class="p">])</span>  <span class="c1"># 第一索引</span>
        <span class="n">trade_date</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">]</span>  <span class="c1"># 第二索引</span>
        <span class="c1"># 转换为时间类型，只保存date</span>
        <span class="n">trade_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">trade_date</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">wrapper_index</span> <span class="o">=</span> <span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">stock_code</span><span class="p">,</span> <span class="n">trade_date</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;stock_code&quot;</span><span class="p">,</span>
                                                                                <span class="s2">&quot;trade_date&quot;</span><span class="p">])</span>
        <span class="n">wrapper_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">wrapper_index</span><span class="p">)</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;equity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;cash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;cumu_r&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;nav&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper_df</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="n">wrapper_df</span><span class="o">.</span><span class="n">equity</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="c1"># 记录买卖点</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;buy_sell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;operation_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;operation_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># 提取买卖点信息</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">bsp_info</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">stock_code</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dd</span><span class="p">),</span> <span class="s2">&quot;buy_sell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span>
            <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">stock_code</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dd</span><span class="p">),</span> <span class="s2">&quot;operation_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">price</span>
            <span class="n">wrapper_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">stock_code</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dd</span><span class="p">),</span> <span class="s2">&quot;operation_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span>
        <span class="k">return</span> <span class="n">wrapper_df</span></div>

<div class="viewcode-block" id="BSgraph.performance"><a class="viewcode-back" href="../graph.html#graph.BSgraph.performance">[文档]</a>    <span class="k">def</span> <span class="nf">performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">trdchg</span><span class="p">,</span>
                    <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">star</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        绘图展现回测期内的高低点和趋势变化</span>

<span class="sd">        :param codename: 回测股票代码或名称</span>
<span class="sd">        :param dir: 图像存放文件夹地址</span>
<span class="sd">        :return: 返回图像文件.jpg</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">main_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;trd&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">)):</span>
            <span class="n">main_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">trd</span><span class="p">]</span>
        <span class="c1"># 以时间为索引</span>
        <span class="n">main_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]))</span>
        <span class="c1"># 确保升序排列</span>
        <span class="n">main_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 绘图设置部分</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">code</span> <span class="o">+</span> <span class="sa">u</span><span class="s2">&quot;择时策略：高低点、趋势及买卖点&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">33</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># 提取上升趋势</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;trd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="c1"># 提取下降趋势</span>
        <span class="n">down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;trd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="c1"># 提取盘整趋势</span>
        <span class="n">consd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;trd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="s1">&#39;consd&#39;</span><span class="p">,</span> <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="c1"># 提取不能判定趋势部分</span>
        <span class="n">na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;trd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="c1"># Part 1：主图部分</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="c1"># 画出各个趋势部分的线</span>
        <span class="n">upline</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;up&#39;</span>
        <span class="p">)</span>
        <span class="n">downline</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">down</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;down&#39;</span>
        <span class="p">)</span>
        <span class="n">consdline</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">consd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;consolidation&#39;</span>
        <span class="p">)</span>
        <span class="n">naline</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span>
        <span class="p">)</span>
        <span class="c1"># 需要补齐趋势类型之间的空隙</span>
        <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;up&#39;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;consd&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span> <span class="s2">&quot;grey&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">trdchg</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">][</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">color_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;trd&#39;</span><span class="p">][</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="c1"># 设置时间标注距离高低点的距离</span>
        <span class="n">scale_text</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
            <span class="p">(</span><span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">main_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="c1"># 提取高低点信息</span>
        <span class="n">hllist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">hlp_info</span>
        <span class="c1"># 提取日线高点信息</span>
        <span class="n">hlist_d</span> <span class="o">=</span> <span class="n">hllist</span><span class="p">[(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;hl&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;daily&quot;</span><span class="p">)]</span>
        <span class="c1"># 提取日线低点信息</span>
        <span class="n">llist_d</span> <span class="o">=</span> <span class="n">hllist</span><span class="p">[(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;hl&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;daily&quot;</span><span class="p">)]</span>
        <span class="c1"># 提取30min高点信息</span>
        <span class="n">hlist_30</span> <span class="o">=</span> <span class="n">hllist</span><span class="p">[(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;hl&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;30min&quot;</span><span class="p">)]</span>
        <span class="c1"># 提取30min低点信息</span>
        <span class="n">llist_30</span> <span class="o">=</span> <span class="n">hllist</span><span class="p">[(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;hl&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;30min&quot;</span><span class="p">)]</span>
        <span class="c1"># 提取5min高点信息</span>
        <span class="n">hlist_5</span> <span class="o">=</span> <span class="n">hllist</span><span class="p">[(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;hl&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5min&quot;</span><span class="p">)]</span>
        <span class="c1"># 提取5min低点信息</span>
        <span class="n">llist_5</span> <span class="o">=</span> <span class="n">hllist</span><span class="p">[(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;hl&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hllist</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5min&quot;</span><span class="p">)]</span>
        <span class="c1"># 提取买卖点信息</span>
        <span class="n">bslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">bsp_info</span>
        <span class="c1"># 提取买点信息</span>
        <span class="n">blist</span> <span class="o">=</span> <span class="n">bslist</span><span class="p">[</span><span class="n">bslist</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span>
        <span class="c1"># 提取卖点信息</span>
        <span class="n">slist</span> <span class="o">=</span> <span class="n">bslist</span><span class="p">[</span><span class="n">bslist</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span>

        <span class="c1"># 日线高点信息时间标注</span>
        <span class="k">for</span> <span class="n">hh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hlist_d</span><span class="p">)):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">hlist_d</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">hh</span><span class="p">],</span>
                <span class="n">hlist_d</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">hh</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">scale_text</span><span class="p">,</span>
                <span class="n">f</span><span class="s2">&quot;H:</span><span class="si">{hlist_d.ix[hh, &#39;price&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="n">hlist_d</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">hh</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
            <span class="p">)</span>
        <span class="c1"># 日线低点时间标注</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">llist_d</span><span class="p">)):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">llist_d</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ll</span><span class="p">],</span>
                <span class="n">llist_d</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale_text</span><span class="p">,</span>
                <span class="n">f</span><span class="s2">&quot;L:</span><span class="si">{llist_d.ix[ll, &#39;price&#39;]}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="n">llist_d</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
            <span class="p">)</span>
        <span class="c1"># 买点信息时间标注</span>
        <span class="n">ref_klist_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span>
        <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blist</span><span class="p">)):</span>
            <span class="n">x_tick_with_shift</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">blist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="s1">&#39;index_d&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_klist_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">ref_klist_t</span><span class="p">[</span><span class="n">x_tick_with_shift</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="n">blist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">scale_text</span><span class="p">,</span>
                <span class="n">blist</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">f</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\n</span><span class="si">{blist.ix[bb, &#39;type&#39;]}</span><span class="s1">:</span><span class="si">{blist.ix[bb, &#39;price&#39;]}</span><span class="se">\n</span><span class="s1">{constant.BUYSELL_TYPE[</span>
<span class="s1">                blist.ix[bb, &#39;type&#39;]][3]}&#39;&#39;&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                         <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">blist</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">bb</span><span class="p">],</span> <span class="n">blist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]),</span>
                         <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">ref_klist_t</span><span class="p">[</span><span class="n">x_tick_with_shift</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                 <span class="n">blist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">scale_text</span><span class="p">),</span>
                         <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">))</span>
        <span class="c1"># 卖点时间标注</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slist</span><span class="p">)):</span>
            <span class="n">x_tick_with_shift</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">slist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">ss</span><span class="p">,</span> <span class="s1">&#39;index_d&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_klist_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">ref_klist_t</span><span class="p">[</span><span class="n">x_tick_with_shift</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="n">slist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">ss</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">scale_text</span><span class="p">,</span>
                <span class="n">slist</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">f</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\n</span><span class="si">{slist.ix[ss, &#39;type&#39;]}</span><span class="s1">:</span><span class="si">{slist.ix[ss, &#39;price&#39;]}</span><span class="se">\n</span><span class="s1">{constant.BUYSELL_TYPE[</span>
<span class="s1">                slist.ix[ss, &#39;type&#39;]][2]}&#39;&#39;&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                         <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">slist</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ss</span><span class="p">],</span> <span class="n">slist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">ss</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]),</span>
                         <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">ref_klist_t</span><span class="p">[</span><span class="n">x_tick_with_shift</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">slist</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">ss</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">scale_text</span><span class="p">),</span>
                         <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">))</span>
        <span class="c1"># 高低点记号标注</span>
        <span class="c1"># # matplotlib内置的颜色和样式</span>
          <span class="c1"># color: b:blue, g:green, r:red, c:cyan, m:magenta, y:yellow, k:black, w:white</span>
          <span class="c1"># marker: o:点, D:钻石形，d:细钻石形 ^:上三角， p:五边形， *：五角星 , v:倒三角，&lt;:左三角，&gt;:右三角，s:方形，h/H:六边形</span>
        <span class="c1"># 日线高点记号</span>
        <span class="n">high_pd</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">hlist_d</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">hlist_d</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="s1">&#39;r^&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span>
        <span class="p">)</span>
        <span class="c1"># 日线低点记号</span>
        <span class="n">low_pd</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">llist_d</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">llist_d</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="s1">&#39;gv&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span>
        <span class="p">)</span>
        <span class="c1"># 30min高点记号标注</span>
        <span class="n">high_p30</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">hlist_30</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">hlist_30</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;rx&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="c1"># 30min低点记号标注</span>
        <span class="n">low_p30</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">llist_30</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">llist_30</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;gx&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="c1"># 5min高点记号标注</span>
        <span class="n">high_p5</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">hlist_5</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">hlist_5</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>
        <span class="c1"># 5min低点记号标注</span>
        <span class="n">low_p5</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">llist_5</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">llist_5</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;g+&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span>
        <span class="p">)</span>
        <span class="c1"># 最末日提示收盘价</span>
        <span class="k">if</span> <span class="n">star</span><span class="p">:</span>
            <span class="n">star_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">main_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="s1">&#39;k*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">13</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">main_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">scale_text</span><span class="p">,</span> <span class="s1">&#39;现价:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">main_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span>
                                                              <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
            <span class="p">)</span>
        <span class="c1"># 买卖点记号标注</span>
        <span class="c1"># 买点记号</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">buy_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">blist</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">blist</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="s1">&#39;r*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span>
            <span class="p">)</span>
        <span class="c1"># 卖点记号</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">slist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">sell_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">slist</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">slist</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span>
            <span class="p">)</span>

        <span class="c1"># 图例</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blist</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">upline</span><span class="p">,</span>
                    <span class="n">downline</span><span class="p">,</span>
                    <span class="n">consdline</span><span class="p">,</span>
                    <span class="n">naline</span><span class="p">,</span>
                    <span class="n">high_pd</span><span class="p">,</span>
                    <span class="n">low_pd</span><span class="p">,</span>
                    <span class="n">high_p30</span><span class="p">,</span>
                    <span class="n">low_p30</span><span class="p">,</span>
                    <span class="n">high_p5</span><span class="p">,</span>
                    <span class="n">low_p5</span><span class="p">,</span>
                    <span class="n">buy_p</span><span class="p">,</span>
                    <span class="n">sell_p</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;up trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;down trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;consolidation trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point in 30min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point in 30min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point in 5min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point in 5min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;buy point&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sell point&quot;</span>
                <span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
                <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">blist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">upline</span><span class="p">,</span>
                    <span class="n">downline</span><span class="p">,</span>
                    <span class="n">consdline</span><span class="p">,</span>
                    <span class="n">naline</span><span class="p">,</span>
                    <span class="n">high_pd</span><span class="p">,</span>
                    <span class="n">low_pd</span><span class="p">,</span>
                    <span class="n">high_p30</span><span class="p">,</span>
                    <span class="n">low_p30</span><span class="p">,</span>
                    <span class="n">high_p5</span><span class="p">,</span>
                    <span class="n">low_p5</span><span class="p">,</span>
                    <span class="n">buy_p</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;up trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;down trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;consolidation trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point in 30min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point in 30min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point in 5min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point in 5min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;buy point&quot;</span>
                <span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
                <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">upline</span><span class="p">,</span>
                    <span class="n">downline</span><span class="p">,</span>
                    <span class="n">consdline</span><span class="p">,</span>
                    <span class="n">naline</span><span class="p">,</span>
                    <span class="n">high_pd</span><span class="p">,</span>
                    <span class="n">low_pd</span><span class="p">,</span>
                    <span class="n">high_p30</span><span class="p">,</span>
                    <span class="n">low_p30</span><span class="p">,</span>
                    <span class="n">high_p5</span><span class="p">,</span>
                    <span class="n">low_p5</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;up trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;down trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;consolidation trend&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point in 30min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point in 30min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;high point in 5min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;low point in 5min&quot;</span>
                <span class="p">),</span>
                <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
                <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># 网格线选项</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;major&#39;</span><span class="p">)</span>
        <span class="c1"># x-axis</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;时间&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;价格&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="c1"># 坐标轴时间格式</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoDateLocator</span><span class="p">())</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

        <span class="c1"># Part 2:第二分图</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="c1"># mkt, = plt.plot(DatetimeIndex(self.stat.cumur_mkt.keys()),</span>
        <span class="c1">#                 list(self.stat.cumur_mkt.values()),</span>
        <span class="c1">#                 color=&quot;#808080&quot;,</span>
        <span class="c1">#                 label=&quot;benchmark_cumu_return&quot;)</span>
        <span class="n">stk</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">cumur_stk</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                        <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">cumur_stk</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#808080&quot;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;stock_cumu_return&quot;</span><span class="p">)</span>
        <span class="n">stg_t_seq</span> <span class="o">=</span> <span class="n">main_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">main_df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">constant</span><span class="o">.</span><span class="n">PERFORMANCE_BEGIN_DATE</span><span class="p">]</span>
        <span class="n">stg</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stg_t_seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stg_t_seq</span><span class="p">)):],</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#DC143C&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;strategy_return&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="p">(</span><span class="n">stk</span><span class="p">,</span> <span class="n">stg</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;stock&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">),</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
            <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;累计收益（%）&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;时间&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoDateLocator</span><span class="p">())</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">))</span>

        <span class="c1"># Part3: 第三分图，表现统计参数    &quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;&#39;&#39;</span><span class="si">{self.trade_env.code}</span><span class="s1">策略表现对比</span><span class="si">{constant.BENCHMARK}</span><span class="se">\n</span><span class="s1">from:{</span>
<span class="s1">        constant.PERFORMANCE_BEGIN_DATE}&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">col_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">constant</span><span class="o">.</span><span class="n">BENCHMARK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">]</span>
        <span class="n">row_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">u</span><span class="s2">&quot;累计收益&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;年化收益&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;年化标准差&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;收益/标准差&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;最大回撤&quot;</span><span class="p">]</span>
        <span class="n">cell_text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">cwid</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
        <span class="n">performance_table</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
            <span class="n">cellText</span><span class="o">=</span><span class="n">cell_text</span><span class="p">,</span>
            <span class="n">rowLoc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">rowLabels</span><span class="o">=</span><span class="n">row_labels</span><span class="p">,</span>
            <span class="n">colLabels</span><span class="o">=</span><span class="n">col_labels</span><span class="p">,</span>
            <span class="n">colLoc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">colWidths</span><span class="o">=</span><span class="n">cwid</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
        <span class="p">)</span>
        <span class="n">performance_table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">performance_table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">table_props</span> <span class="o">=</span> <span class="n">performance_table</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
        <span class="n">table_cells</span> <span class="o">=</span> <span class="n">table_props</span><span class="p">[</span><span class="s2">&quot;child_artists&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">table_cells</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="mf">0.14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdir</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{dir}</span><span class="s2">/BS_</span><span class="si">{self.trade_env.code}</span><span class="s2">.png&quot;</span>
        <span class="c1"># 保存图像</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gdir</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gdir</span></div>

<div class="viewcode-block" id="BSgraph.strategy_info"><a class="viewcode-back" href="../graph.html#graph.BSgraph.strategy_info">[文档]</a>    <span class="k">def</span> <span class="nf">strategy_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lasthl</span><span class="p">,</span> <span class="n">space_h</span><span class="p">,</span> <span class="n">space_l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回股票在总表中的观测信息</span>
<span class="sd">        :param lasthl: 最后一个高点或者低点的index</span>
<span class="sd">        :return: Strategy_s表中对应信息tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="Stat"><a class="viewcode-back" href="../graph.html#graph.Stat">[文档]</a><span class="k">class</span> <span class="nc">Stat</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hlp_env</span><span class="p">,</span> <span class="n">trd_env</span><span class="p">,</span> <span class="n">trade_env</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span> <span class="o">=</span> <span class="n">hlp_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trd_env</span> <span class="o">=</span> <span class="n">trd_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span> <span class="o">=</span> <span class="n">trade_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlp_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsp_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mkt_p</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cumur_stk</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cumur_mkt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Stat.get_hl_info"><a class="viewcode-back" href="../graph.html#graph.Stat.get_hl_info">[文档]</a>    <span class="k">def</span> <span class="nf">get_hl_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hlp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 记入日线高点</span>
        <span class="k">for</span> <span class="n">kdh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">hpi</span><span class="p">:</span>
            <span class="n">hlp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kdh</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kdh</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                        <span class="s2">&quot;H&quot;</span><span class="p">,</span>
                        <span class="n">constant</span><span class="o">.</span><span class="n">K_LEV_DICT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kdh</span><span class="p">]</span><span class="o">.</span><span class="n">hl_confirmed</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
        <span class="c1"># 记入日线低点</span>
        <span class="k">for</span> <span class="n">kdl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">:</span>
            <span class="n">hlp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kdl</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kdl</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">,</span>
                        <span class="s2">&quot;L&quot;</span><span class="p">,</span>
                        <span class="n">constant</span><span class="o">.</span><span class="n">K_LEV_DICT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">kdl</span><span class="p">]</span><span class="o">.</span><span class="n">hl_confirmed</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
        <span class="c1"># 记入30min高点</span>
        <span class="k">for</span> <span class="n">k30h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">hp30</span><span class="p">:</span>
            <span class="n">hlp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k30h</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">k30h</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">K_LEV_DICT</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k30l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">lp30</span><span class="p">:</span>
            <span class="n">hlp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k30l</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">k30l</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">K_LEV_DICT</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="c1"># 记入5min高点</span>
        <span class="k">for</span> <span class="n">k5h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">hp5</span><span class="p">:</span>
            <span class="n">hlp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k5h</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">k5h</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">K_LEV_DICT</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k5l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">lp5</span><span class="p">:</span>
            <span class="n">hlp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k5l</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">k5l</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">K_LEV_DICT</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">hlp</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlp_info</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">hlp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="s2">&quot;hl&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;confirmed_date&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlp_info</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">DatetimeIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_info</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlp_info</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hlp</span></div>

<div class="viewcode-block" id="Stat.get_bs_info"><a class="viewcode-back" href="../graph.html#graph.Stat.get_bs_info">[文档]</a>    <span class="k">def</span> <span class="nf">get_bs_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bsp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">bs_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Trade.Buy&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">bs</span><span class="p">)):</span>
                <span class="n">bsp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bs</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span>
                            <span class="n">bs</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">.</span><span class="n">stop_p</span><span class="p">,</span> <span class="n">bs</span><span class="o">.</span><span class="n">max_profit</span><span class="p">,</span> <span class="n">bs</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">,</span> <span class="n">bs</span><span class="o">.</span><span class="n">operate_lev</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">sell_p</span><span class="p">)</span> <span class="k">if</span> <span class="n">bs</span><span class="o">.</span><span class="n">sell_p</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bsp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bs</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bs</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span> <span class="n">bs</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">bs</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span>
                            <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">buy_p</span><span class="p">)))</span>
        <span class="n">bsp</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsp_info</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">bsp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;index_d&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;stop_p&quot;</span><span class="p">,</span> <span class="s2">&quot;max_r&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;cumu_r&quot;</span><span class="p">,</span> <span class="s2">&quot;lev_chg&quot;</span><span class="p">,</span> <span class="s2">&quot;counter_opt&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsp_info</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">DatetimeIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bsp_info</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsp_info</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bsp</span></div>

<div class="viewcode-block" id="Stat.get_account_info"><a class="viewcode-back" href="../graph.html#graph.Stat.get_account_info">[文档]</a>    <span class="k">def</span> <span class="nf">get_account_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">account</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">account</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">account</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">account</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Stat.get_strategy_info"><a class="viewcode-back" href="../graph.html#graph.Stat.get_strategy_info">[文档]</a>    <span class="k">def</span> <span class="nf">get_strategy_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Stat.get_performance"><a class="viewcode-back" href="../graph.html#graph.Stat.get_performance">[文档]</a>    <span class="k">def</span> <span class="nf">get_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> \
               <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">),</span> \
            <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.trade_env.code}</span><span class="s2">: account cumulative returns length {len(self.trade_env.account.cumu_r)} &quot;</span> \
            <span class="n">f</span><span class="s2">&quot;doesn&#39;t match K objects length {len(self.trade_env.klist)}&quot;</span>
        <span class="n">performance_t_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">])</span>
        <span class="n">performance_begin_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">performance_t_seq</span> <span class="o">&gt;=</span>
                                               <span class="n">constant</span><span class="o">.</span><span class="n">PERFORMANCE_BEGIN_DATE</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">stg_mkt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">cash</span><span class="p">[(</span><span class="n">performance_begin_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):])</span> <span class="o">+</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">equity</span><span class="p">[(</span><span class="n">performance_begin_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]))</span>
        <span class="n">stk_mkt</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">close</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">][</span><span class="n">performance_begin_index</span><span class="p">:]</span>
        <span class="n">r_stg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stg_mkt</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stg_mkt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">mkt_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkt_p</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># 累计收益</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cumur_mkt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mkt_p</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                  <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mkt_p</span><span class="p">,</span> <span class="p">[</span><span class="n">mkt_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mkt_p</span><span class="p">)))))</span>
        <span class="c1"># 股票自身累计收益</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cumur_stk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">performance_t_seq</span><span class="p">[</span><span class="n">performance_begin_index</span><span class="p">:]),</span>
                                  <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stk_mkt</span><span class="p">,</span> <span class="p">[</span><span class="n">stk_mkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span>
                                      <span class="n">stk_mkt</span><span class="p">)))))</span>
        <span class="n">cumu_r_mkt</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">mkt_p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">mkt_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="n">cumu_r_stg</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="n">cumu_r_stk</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span>
            <span class="n">performance_begin_index</span><span class="p">]</span><span class="o">.</span><span class="n">close</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="c1"># 年化收益</span>
        <span class="n">stk_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">close</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">performance_begin_index</span><span class="p">:]]</span>
        <span class="n">r_stk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stk_p</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stk_p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">r_mkt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mkt_p</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mkt_p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">annu_r_mkt</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">r_mkt</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="n">annu_sd_mkt</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">r_mkt</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="n">r_sd_ratio_mkt</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">r_mkt</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span> <span class="o">**</span> <span class="mf">0.5</span><span class="o">/</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">r_mkt</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">annu_r_stk</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">r_stk</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="n">annu_sd_stk</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">r_stk</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="n">r_sd_ratio_stk</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">r_stk</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span> <span class="o">**</span> <span class="mf">0.5</span><span class="o">/</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">r_stk</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">annu_r_stg</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">r_stg</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="n">annu_sd_stg</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">r_stg</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_sd_ratio_stg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">r_stg</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_TRADE</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">/</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">r_stg</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="n">r_sd_ratio_stg</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">max_drawdown_stk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">(</span><span class="n">stk_p</span><span class="p">)</span>
        <span class="n">max_drawdown_stg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">(</span><span class="n">stg_mkt</span><span class="p">)</span>
        <span class="n">max_drawdown_mkt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">(</span><span class="n">mkt_p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="p">{</span><span class="sa">u</span><span class="s2">&quot;累计收益&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cumu_r_mkt</span><span class="p">,</span> <span class="n">cumu_r_stk</span><span class="p">,</span> <span class="n">cumu_r_stg</span><span class="p">],</span>
                <span class="sa">u</span><span class="s2">&quot;年化收益&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">annu_r_mkt</span><span class="p">,</span> <span class="n">annu_r_stk</span><span class="p">,</span> <span class="n">annu_r_stg</span><span class="p">],</span>
                <span class="sa">u</span><span class="s2">&quot;年化标准差&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">annu_sd_mkt</span><span class="p">,</span> <span class="n">annu_sd_stk</span><span class="p">,</span> <span class="n">annu_sd_stg</span><span class="p">],</span>
                <span class="sa">u</span><span class="s2">&quot;收益/标准误&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r_sd_ratio_mkt</span><span class="p">,</span> <span class="n">r_sd_ratio_stk</span><span class="p">,</span> <span class="n">r_sd_ratio_stg</span><span class="p">],</span>
                <span class="sa">u</span><span class="s2">&quot;最大回撤&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">max_drawdown_mkt</span><span class="p">,</span> <span class="n">max_drawdown_stk</span><span class="p">,</span> <span class="n">max_drawdown_stg</span><span class="p">]}</span></div>

<div class="viewcode-block" id="Stat.max_drawdown"><a class="viewcode-back" href="../graph.html#graph.Stat.max_drawdown">[文档]</a>    <span class="k">def</span> <span class="nf">max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">):</span>
        <span class="c1"># 回撤开始时间</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">-</span> <span class="n">series</span><span class="p">)</span>
        <span class="c1"># 回撤结束时间</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">series</span><span class="p">[:</span><span class="n">jj</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;.2%&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Stat.get_mkt_p"><a class="viewcode-back" href="../graph.html#graph.Stat.get_mkt_p">[文档]</a>    <span class="k">def</span> <span class="nf">get_mkt_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span>
            <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">wsd</span><span class="p">(</span><span class="n">constant</span><span class="o">.</span><span class="n">BENCHMARK</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                                     <span class="n">constant</span><span class="o">.</span><span class="n">PERFORMANCE_BEGIN_DATE</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">res_t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> 15:00:00&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">Times</span><span class="p">]</span>
        <span class="n">mkt_p</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mkt_p</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_t</span><span class="p">,</span> <span class="n">mkt_p</span><span class="p">)))</span></div></div>


<span class="c1"># 运行参数设置函数</span>
<div class="viewcode-block" id="runbacktest"><a class="viewcode-back" href="../graph.html#graph.runbacktest">[文档]</a><span class="k">def</span> <span class="nf">runbacktest</span><span class="p">(</span>
        <span class="n">begin</span><span class="p">,</span>
        <span class="n">codename</span><span class="p">,</span>
        <span class="nb">dir</span><span class="p">,</span>
        <span class="n">end</span><span class="p">,</span>
        <span class="n">paint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">star</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    设置策略环境参数，并运行部分回测策略</span>
<span class="sd">    :param begin: 回测开始时间</span>
<span class="sd">    :param codename: 回测股票代码或名称</span>
<span class="sd">    :param dir: 作图目录地址</span>
<span class="sd">    :param end: 回测结束时间，默认当前</span>
<span class="sd">    :param paint: bool值，是否画图，默认为True</span>
<span class="sd">    :param star: bool值，最后一个标记星星，默认为False</span>
<span class="sd">    :return: 返回策略环境对象整体和图像地址</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;BS日线策略：正在回测</span><span class="si">{codename}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">klist</span> <span class="o">=</span> <span class="n">ldd</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">codename</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">loaddataError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">loaddataError</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{codename}</span><span class="s2">获取日K线数{len(klist)}&quot;</span><span class="p">)</span>
    <span class="c1"># 由于klist数据集是被hlp_env, trd_env和trade_env共享的，指向同一地址</span>
    <span class="c1"># 因此任意指针均可调用</span>
    <span class="c1"># 设置策略运行参数环境</span>
    <span class="n">hlp_env</span> <span class="o">=</span> <span class="n">HLPoint</span><span class="p">(</span><span class="n">klist</span><span class="p">,</span> <span class="n">codename</span><span class="p">)</span>
    <span class="n">hlp_env</span><span class="o">.</span><span class="n">init_hl</span><span class="p">()</span>
    <span class="n">hlp_env</span><span class="o">.</span><span class="n">get_hl</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">trd_env</span> <span class="o">=</span> <span class="n">Trend</span><span class="p">(</span><span class="n">hlp_env</span><span class="p">)</span>
        <span class="n">trd_env</span><span class="o">.</span><span class="n">get_trend</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">TrendError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">trade_env</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">codename</span><span class="p">,</span>
                          <span class="n">klist</span><span class="o">=</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">klist</span><span class="p">,</span>
                          <span class="n">hpi</span><span class="o">=</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">hpi</span><span class="p">,</span>
                          <span class="n">lpi</span><span class="o">=</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">)</span>
        <span class="n">trade_env</span><span class="o">.</span><span class="n">get_bs</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trade_env</span><span class="o">.</span><span class="n">klist</span><span class="p">:</span>
        <span class="n">k</span><span class="o">.</span><span class="n">t</span> <span class="o">+=</span> <span class="s2">&quot; 15:00:00&quot;</span>  <span class="c1"># 统一日线时间与分钟级别时间的表示方法 &quot;yyyy-mm-dd HH:MM:SS&quot;</span>
    <span class="c1"># note = [[1, hlp_env.temp_h, hlp_env.temp_min],</span>
    <span class="c1">#         [0, hlp_env.temp_l, hlp_env.temp_max]][hlp_env.hl == &quot;l&quot;]</span>
    <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_CTYPE</span><span class="p">,</span> <span class="s2">&quot;chinese&quot;</span><span class="p">)</span>
    <span class="c1"># 创建回测表现统计操作对象</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">Stat</span><span class="p">(</span><span class="n">hlp_env</span><span class="o">=</span><span class="n">hlp_env</span><span class="p">,</span> <span class="n">trd_env</span><span class="o">=</span><span class="n">trd_env</span><span class="p">,</span> <span class="n">trade_env</span><span class="o">=</span><span class="n">trade_env</span><span class="p">)</span>
    <span class="n">stat</span><span class="o">.</span><span class="n">get_mkt_p</span><span class="p">()</span>
    <span class="n">hlp_tb</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get_hl_info</span><span class="p">()</span>
    <span class="n">bsp_tb</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get_bs_info</span><span class="p">()</span>
    <span class="n">account_row</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
    <span class="n">strategy_row</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">get_strategy_info</span><span class="p">()</span>
    <span class="c1"># 打包回测结果总结</span>
    <span class="c1"># res_pac = {&quot;hlp&quot;: hlp_tb, &quot;bsp&quot;: bsp_tb, &quot;account&quot;: account_row, &quot;strategy&quot;: strategy_row}</span>
    <span class="n">stat</span><span class="o">.</span><span class="n">get_performance</span><span class="p">()</span>
    <span class="c1"># 创建图像操作对象</span>
    <span class="n">graph_obj</span> <span class="o">=</span> <span class="n">BSgraph</span><span class="p">(</span><span class="n">trade_env</span><span class="o">=</span><span class="n">trade_env</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span>
    <span class="c1"># 向回测全局对象返回结果总结</span>
    <span class="n">wrapper_df</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">wrapper_to_global_backtest</span><span class="p">()</span>
    <span class="c1"># 该股票在总表中的信息</span>
    <span class="k">if</span> <span class="n">paint</span><span class="p">:</span>
        <span class="c1"># 绘图并获取图像地址</span>
        <span class="n">gdir</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">performance</span><span class="p">(</span>
            <span class="n">trdchg</span><span class="o">=</span><span class="n">trd_env</span><span class="o">.</span><span class="n">trdchg</span><span class="p">,</span>
            <span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span>
            <span class="n">star</span><span class="o">=</span><span class="n">star</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;回测图像输出到</span><span class="si">{gdir}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># return res_pac, gdir</span>
        <span class="k">return</span> <span class="n">wrapper_df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># return res_pac</span>
        <span class="k">return</span> <span class="n">wrapper_df</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">constant</span><span class="o">.</span><span class="n">reset_params</span><span class="p">()</span>
    <span class="n">constant</span><span class="o">.</span><span class="n">check_dir</span><span class="p">()</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">constant</span><span class="o">.</span><span class="n">BEGIN_DATE</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">constant</span><span class="o">.</span><span class="n">END_DATE</span>
    <span class="c1"># 读入对象</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">constant</span><span class="o">.</span><span class="n">CODE_FILE</span><span class="p">)</span>
    <span class="c1"># 创建全局回测对象</span>
    <span class="c1"># global_backtest_obj = GlobalBacktest(start_time=start_time,</span>
    <span class="c1">#                                      end_time=end_time)</span>
    <span class="c1"># global_backtest_obj.run_backtest(global_index=&quot;000300.SH&quot;,</span>
    <span class="c1">#                                  func=runbacktest,</span>
    <span class="c1">#                                  key_params=dict(begin=start_time, end=end_time,</span>
    <span class="c1">#                                                  dir=constant.GRAPH))</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
        <span class="n">runbacktest</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
                    <span class="nb">dir</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">GRAPH</span><span class="p">,</span> <span class="n">codename</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                    <span class="p">)</span>








</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">模块代码</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Maggie Hu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>