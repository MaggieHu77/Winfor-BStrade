
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_cn">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>trade &#8212; BStrade beta v0.7.1 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>trade 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># ! python3</span>
<span class="kn">import</span> <span class="nn">constant</span>
<span class="kn">from</span> <span class="nn">misc</span> <span class="k">import</span> <span class="n">printt</span>
<span class="kn">from</span> <span class="nn">loadData</span> <span class="k">import</span> <span class="n">loadData_min</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">floor</span>
<span class="kn">from</span> <span class="nn">hlPoint</span> <span class="k">import</span> <span class="n">HLPointMin</span>
<span class="kn">from</span> <span class="nn">defindex</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">defindex</span> <span class="k">import</span> <span class="n">Kti</span>


<div class="viewcode-block" id="Trade"><a class="viewcode-back" href="../trade.html#trade.Trade">[文档]</a><span class="k">class</span> <span class="nc">Trade</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">klist</span><span class="p">,</span> <span class="n">hpi</span><span class="p">,</span> <span class="n">lpi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">klist</span> <span class="o">=</span> <span class="n">klist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_sell</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpi</span> <span class="o">=</span> <span class="n">hpi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpi</span> <span class="o">=</span> <span class="n">lpi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 所有发生过的买卖记录，按照时间先后排序</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 当前未平仓的买入交易</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_s</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 发生过的卖出交易</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Account</span><span class="p">(</span><span class="n">trade_len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">klist</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp30</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp30</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp5</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp5</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Trade.Buy"><a class="viewcode-back" href="../trade.html#trade.Trade.Buy">[文档]</a>    <span class="k">class</span> <span class="nc">Buy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        定义买点对象相关性质和方法</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Kti</span><span class="p">,</span> <span class="n">typ</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span>
                     <span class="n">stop_p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_k</span> <span class="o">=</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_p</span> <span class="o">=</span> <span class="n">stop_p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_profit</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 针对此买点的寻找卖点操作级别</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sell_p</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 级别转变操作对象，用于寻找特殊卖点</span>

<div class="viewcode-block" id="Trade.Buy.register"><a class="viewcode-back" href="../trade.html#trade.Trade.Buy.register">[文档]</a>        <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">buy</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                                           <span class="n">buy_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="Trade.Buy.sold"><a class="viewcode-back" href="../trade.html#trade.Trade.Buy.sold">[文档]</a>        <span class="k">def</span> <span class="nf">sold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sell_p</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            卖出操作记录：对应卖点对象实例，清仓标记</span>
<span class="sd">            :param sell_p: 卖点对象实例</span>
<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sell_p</span> <span class="o">=</span> <span class="n">sell_p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Trade.Buy.refresh"><a class="viewcode-back" href="../trade.html#trade.Trade.Buy.refresh">[文档]</a>        <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">current_high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">cursor</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            每个K线出现后，更新买点收益状态</span>
<span class="sd">            :param current_p: 当前价格</span>
<span class="sd">            :param current_high: 当前最高价</span>
<span class="sd">            :param cursor: 刷新价格当日索引</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">buy_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cursor</span> <span class="o">&gt;=</span> <span class="n">buy_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">current_p</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 更新累计收益</span>
                <span class="n">cumu_with_r</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">current_high</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 更新用最高价计算的累计收益</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_profit</span> <span class="o">&lt;</span> <span class="n">constant</span><span class="o">.</span><span class="n">THRESH_PROFIT</span> <span class="ow">and</span> <span class="n">cumu_with_r</span> <span class="o">&gt;=</span> <span class="n">constant</span><span class="o">.</span><span class="n">THRESH_PROFIT</span><span class="p">:</span>
                    <span class="c1"># 在第一次累计收益达到阈值的时候，更新止盈价格（抬高）基准</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reset_stop_p</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_profit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_profit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trade.Buy.reset_stop_p"><a class="viewcode-back" href="../trade.html#trade.Trade.Buy.reset_stop_p">[文档]</a>        <span class="k">def</span> <span class="nf">reset_stop_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">constant</span><span class="o">.</span><span class="n">THRESH_STOPPROFIT</span><span class="p">)</span>  <span class="c1"># 止盈点参考价格设为买入价加上一定保底收益</span></div></div>

<div class="viewcode-block" id="Trade.Sell"><a class="viewcode-back" href="../trade.html#trade.Trade.Sell">[文档]</a>    <span class="k">class</span> <span class="nc">Sell</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        定义卖点对象相关性质和方法</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">buy_p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_k</span> <span class="o">=</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy_p</span> <span class="o">=</span> <span class="n">buy_p</span>  <span class="c1"># 卖点对象知道其对应买点对象是谁，但买点对象暂时不知道其卖点是谁</span>

<div class="viewcode-block" id="Trade.Sell.register"><a class="viewcode-back" href="../trade.html#trade.Trade.Sell.register">[文档]</a>        <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            卖点操作发生：”通知”账户对象实例记录本次交易，并处理其历史对应买点</span>
<span class="sd">            :return:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sell</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">sell_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy_p</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy_p</span><span class="o">.</span><span class="n">sell_p</span> <span class="o">=</span> <span class="bp">self</span></div></div>

<div class="viewcode-block" id="Trade.Account"><a class="viewcode-back" href="../trade.html#trade.Trade.Account">[文档]</a>    <span class="k">class</span> <span class="nc">Account</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        记录交易及账户资产变动情况</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_len</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">equity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cumu_r</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trade_len</span> <span class="o">=</span> <span class="n">trade_len</span>  <span class="c1"># 回测期的长度，注意多出一格作为初始状态</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">constant</span><span class="o">.</span><span class="n">INIT_FUND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 账户现金</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy2_pct</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">constant</span><span class="o">.</span><span class="n">BUY1_PCT</span><span class="p">)</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">BUY2_PCT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 持有手数--&gt;累计值</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">equity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 股权价值</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">cumu_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 累计收益</span>

<div class="viewcode-block" id="Trade.Account.buy"><a class="viewcode-back" href="../trade.html#trade.Trade.Account.buy">[文档]</a>        <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">buy_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            定义买入操作</span>
<span class="sd">            :param typ: 买点级别</span>
<span class="sd">            :param price: 买入价位</span>
<span class="sd">            :param buy_idx: 买入操作发生时对应的日K索引</span>
<span class="sd">            :return: delta_vol，买入手数</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">constant</span><span class="o">.</span><span class="n">BUYSELL_TYPE</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>
            <span class="n">buy_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># 第一类买点</span>
                <span class="n">delta_vol</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">BUY1_PCT</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>  <span class="c1"># 计算交易量</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_vol</span>  <span class="c1"># 当前持仓总手数</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta_vol</span> <span class="o">*</span> <span class="n">price</span>  <span class="c1"># 当前账户剩余现金</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">price</span>  <span class="c1"># 按当前买入价格计算，资产账户总市值</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">+</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                              <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 账户现金+资产市值的累计收益率</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 第二、三类买点</span>
                <span class="n">delta_vol</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy2_pct</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_vol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta_vol</span> <span class="o">*</span> <span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">]</span> <span class="o">+</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">buy_idx</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">delta_vol</span></div>

<div class="viewcode-block" id="Trade.Account.sell"><a class="viewcode-back" href="../trade.html#trade.Trade.Account.sell">[文档]</a>        <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">sell_idx</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            定义卖出操作</span>
<span class="sd">            :param price: 卖出价格</span>
<span class="sd">            :param volume: 卖出手数</span>
<span class="sd">            :param sell_idx: 卖出时日K的序号索引</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sell_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">volume</span>  <span class="c1"># 剩余持仓手数</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">price</span> <span class="o">*</span> <span class="n">volume</span>  <span class="c1"># 当前账户现金总数</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">price</span>  <span class="c1"># 剩余资产以卖出价格计价市值</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">]</span> <span class="o">+</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">sell_idx</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                           <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 当前账户总值计价累计收益率</span></div>

<div class="viewcode-block" id="Trade.Account.sum_up"><a class="viewcode-back" href="../trade.html#trade.Trade.Account.sum_up">[文档]</a>        <span class="k">def</span> <span class="nf">sum_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_p</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">cursor</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            当日K结束后更新账户状态</span>
<span class="sd">            :param current_p: 当前价格，一般指收盘价</span>
<span class="sd">            :param cursor: 当前日K索引</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">cursor</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span> <span class="o">*</span> <span class="n">current_p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cumu_r</span><span class="p">[</span><span class="n">cursor</span><span class="p">:]</span> <span class="o">=</span> \
                <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">[</span><span class="n">cursor</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Trade.seek_to_buy_s"><a class="viewcode-back" href="../trade.html#trade.Trade.seek_to_buy_s">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">seek_to_buy_s</span><span class="p">(</span><span class="n">pre_low</span><span class="p">,</span> <span class="n">pre_high30</span><span class="p">,</span> <span class="n">num_h30</span><span class="p">,</span> <span class="n">num_l30</span><span class="p">,</span>
                      <span class="n">pre_low30</span><span class="p">,</span> <span class="n">stamp</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">pre_trend</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
                      <span class="n">account</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">last_bs_typ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        用于单步买点查找，必须有30min的高低点至少三个，高点在前；才能有效构成买入</span>
<span class="sd">        :param pre_low: 点日线低点</span>
<span class="sd">        :param pre_high30: 前30min高点</span>
<span class="sd">        :param pre_low30: 前30min低点</span>
<span class="sd">        :param stamp: 当前时间戳</span>
<span class="sd">        :param trd: 当前趋势</span>
<span class="sd">        :param index: 如果确认买点的编号</span>
<span class="sd">        :param typ: 如果确认买点的类型</span>
<span class="sd">        :param account: Account对象</span>
<span class="sd">        :param high: 当前最高价</span>
<span class="sd">        :param low: 当前最低价</span>
<span class="sd">        :param price: 如果满足条件，以此价格买入</span>
<span class="sd">        :param last_bs_typ: 上一个买卖操作的类型</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">buy_p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span> <span class="ow">and</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">pre_low</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">buy_in_min30_s</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">pre_low</span><span class="o">=</span><span class="n">pre_low</span><span class="p">,</span> <span class="n">pre_high30</span><span class="o">=</span><span class="n">pre_high30</span><span class="p">,</span>
                                       <span class="n">stamp</span><span class="o">=</span><span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s2">&quot;B1-0&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                                       <span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">pre_low30</span><span class="o">=</span><span class="n">pre_low30</span><span class="p">,</span> <span class="n">num_h30</span><span class="o">=</span><span class="n">num_h30</span><span class="p">,</span>
                                       <span class="n">num_l30</span><span class="o">=</span><span class="n">num_l30</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">buy_p</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;consd&quot;</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pre_trend</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span> <span class="ow">and</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">pre_low</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">buy_in_min30_s</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">pre_low</span><span class="o">=</span><span class="n">pre_low</span><span class="p">,</span> <span class="n">pre_high30</span><span class="o">=</span><span class="n">pre_high30</span><span class="p">,</span>
                                       <span class="n">stamp</span><span class="o">=</span><span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s2">&quot;B2-0&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                                       <span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">pre_low30</span><span class="o">=</span><span class="n">pre_low30</span><span class="p">,</span> <span class="n">num_h30</span><span class="o">=</span><span class="n">num_h30</span><span class="p">,</span>
                                       <span class="n">num_l30</span><span class="o">=</span><span class="n">num_l30</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">buy_p</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">==</span> <span class="s2">&quot;consd&quot;</span> <span class="ow">and</span> <span class="n">pre_trend</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="ow">and</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">pre_low</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">buy_in_min30_s</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">pre_low</span><span class="o">=</span><span class="n">pre_low</span><span class="p">,</span> <span class="n">pre_high30</span><span class="o">=</span><span class="n">pre_high30</span><span class="p">,</span>
                                       <span class="n">stamp</span><span class="o">=</span><span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s2">&quot;B2-0&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                                       <span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">pre_low30</span><span class="o">=</span><span class="n">pre_low30</span><span class="p">,</span> <span class="n">num_h30</span><span class="o">=</span><span class="n">num_h30</span><span class="p">,</span>
                                       <span class="n">num_l30</span><span class="o">=</span><span class="n">num_l30</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">buy_p</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="ow">and</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">pre_low</span> <span class="ow">and</span> <span class="n">last_bs_typ</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;S4&quot;</span><span class="p">,</span> <span class="s2">&quot;S5&quot;</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">buy_in_min30_s</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">pre_low</span><span class="o">=</span><span class="n">pre_low</span><span class="p">,</span> <span class="n">pre_high30</span><span class="o">=</span><span class="n">pre_high30</span><span class="p">,</span>
                                       <span class="n">stamp</span><span class="o">=</span><span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s2">&quot;B3-0&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                                       <span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">pre_low30</span><span class="o">=</span><span class="n">pre_low30</span><span class="p">,</span> <span class="n">num_h30</span><span class="o">=</span><span class="n">num_h30</span><span class="p">,</span>
                                       <span class="n">num_l30</span><span class="o">=</span><span class="n">num_l30</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">buy_p</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">flag</span><span class="p">,</span> <span class="n">operate_lev_buy</span><span class="p">,</span> <span class="n">buy_p</span></div>

<div class="viewcode-block" id="Trade.seek_to_buy"><a class="viewcode-back" href="../trade.html#trade.Trade.seek_to_buy">[文档]</a>    <span class="k">def</span> <span class="nf">seek_to_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        处理买入操作</span>
<span class="sd">        :return: 是否发生买入操作</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否发生买入操作</span>
        <span class="n">h_confirmed</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">hh</span><span class="p">]</span><span class="o">.</span><span class="n">hl_confirmed</span> <span class="k">for</span> <span class="n">hh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpi</span><span class="p">]</span>  <span class="c1"># 回测期间内所有高点被确认时的K线序号</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">in</span> <span class="n">h_confirmed</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">lpi</span><span class="p">):</span>  <span class="c1">#</span>
            <span class="c1"># 如果本K线当日确认了高点，且非第一个高低点</span>
            <span class="n">last_opt</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">typ</span>
            <span class="n">pre_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 前低点序列号</span>
            <span class="n">pre_low_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pre_low</span><span class="p">)</span>  <span class="c1"># 前低点在低点序列内的序列号</span>
            <span class="c1"># 如果前低点不是回测区间内最后一个低点，那么30min数据提取范围从本K线到后一低点被确认当日结束；否则从本K线到回测期最后一日</span>
            <span class="c1"># 此处不涉及未来函数，因为在逐日监控中，30min买点寻找在低点被确认当日自然停止</span>
            <span class="n">l_confirmed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pre_low</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="n">pre_low_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">hl_confirmed</span>
            <span class="c1"># 左侧买点，下跌过程中，高点确认时尚未跌破前低（存在下一低点比前低点抬高的可能）</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trd</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">pre_low</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 转换买入操作级别为30min级别</span>
                <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_buy`，尝试寻找第一买点，位置</span><span class="si">{self.cursor}</span><span class="s2">；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;确认高点处于下跌趋势中，目前未跌破前低点；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;30min搜索范围</span><span class="si">{self.cursor}</span><span class="s2">~</span><span class="si">{l_confirmed}</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                       <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_min30</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="n">l_confirmed</span><span class="p">,</span> <span class="n">pre_low</span><span class="p">,</span> <span class="s2">&quot;B1-0&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pre_low_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_buy`，转而尝试寻找日线第一买点，位置</span><span class="si">{self.cursor}</span><span class="s2">&quot;</span><span class="p">,</span>
                               <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                               <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                        <span class="c1"># NOTE: 不需要额外增加判定日线低点抬高的条件，因为如果中间跌破前低，res[0]为True</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="n">pre_low_i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;B1-1&quot;</span><span class="p">)</span>
                        <span class="c1"># self.operate_lev_buy = [2, 1][flag]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trd</span> <span class="o">==</span> <span class="s2">&quot;consd&quot;</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">pre_trd</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">pre_low</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                <span class="c1"># 由下跌转为盘整趋势中（说明被确认的高点高于前高，而前两个低点降低），目前尚未跌破前低</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_buy`，尝试寻找第二买点，位置</span><span class="si">{self.cursor}</span><span class="s2">；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;确认高点处于下跌趋势转为盘整，目前未跌破前低点；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;30min搜索范围</span><span class="si">{self.cursor}</span><span class="s2">~</span><span class="si">{l_confirmed}</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                       <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_min30</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="n">l_confirmed</span><span class="p">,</span> <span class="n">pre_low</span><span class="p">,</span> <span class="s2">&quot;B2-0&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pre_low_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="n">pre_low_i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;B2-1&quot;</span><span class="p">)</span>
                        <span class="c1"># self.operate_lev_buy = [2, 1][flag]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trd</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">pre_low</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="ow">and</span> <span class="n">last_opt</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> \
                    <span class="p">(</span><span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="s2">&quot;B3&quot;</span><span class="p">):</span>
                <span class="c1"># 当前处于上涨趋势中，且上一操作不是第二买点或第三买点</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_buy`，尝试寻找第二（三）买点，位置</span><span class="si">{self.cursor}</span><span class="s2">；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;确认高点处于上涨趋势中，目前未跌破前低点；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;30min搜索范围</span><span class="si">{self.cursor}</span><span class="s2">~</span><span class="si">{l_confirmed}</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                       <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_min30</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="n">l_confirmed</span><span class="p">,</span> <span class="n">pre_low</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;B2-0&quot;</span><span class="p">,</span> <span class="s2">&quot;B3-0&quot;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span>
                    <span class="n">last_opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;S4&quot;</span><span class="p">,</span> <span class="s2">&quot;S5&quot;</span><span class="p">))])</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pre_low_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="n">pre_low_i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;B2-1&quot;</span><span class="p">,</span> <span class="s2">&quot;B3-1&quot;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span>
                    <span class="n">last_opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;S4&quot;</span><span class="p">,</span> <span class="s2">&quot;S5&quot;</span><span class="p">))])</span>
                        <span class="c1"># self.operate_lev_buy = [2, 1][flag]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trd</span> <span class="o">==</span> <span class="s2">&quot;consd&quot;</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">pre_trd</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">pre_low</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="ow">and</span> \
                <span class="s2">&quot;B1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">last_opt</span><span class="p">:</span>
                <span class="c1"># 由上涨转入盘整趋势中，高点低点区间连续放宽</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_buy`，尝试寻找第买点一，位置</span><span class="si">{self.cursor}</span><span class="s2">；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;上涨趋势转为盘整，目前未跌破前低点；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;30min搜索范围</span><span class="si">{self.cursor}</span><span class="s2">~</span><span class="si">{l_confirmed}</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                       <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_min30</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="n">l_confirmed</span><span class="p">,</span> <span class="n">pre_low</span><span class="p">,</span> <span class="s2">&quot;B1-0&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pre_low_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_in_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="n">pre_low_i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;B1-1&quot;</span><span class="p">)</span>
                        <span class="c1"># self.operate_lev_buy = [2, 1][flag]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">flag</span></div>

<div class="viewcode-block" id="Trade.buy_in_min30_s"><a class="viewcode-back" href="../trade.html#trade.Trade.buy_in_min30_s">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">buy_in_min30_s</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">pre_low</span><span class="p">,</span> <span class="n">pre_high30</span><span class="p">,</span>
                       <span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span>
                       <span class="n">account</span><span class="p">,</span> <span class="n">pre_low30</span><span class="p">,</span> <span class="n">num_h30</span><span class="p">,</span> <span class="n">num_l30</span><span class="p">):</span>
        <span class="n">flag1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">flag2</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">buy_p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">pre_low</span><span class="p">:</span>
            <span class="n">flag1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_h30</span> <span class="o">+</span> <span class="n">num_l30</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="n">pre_high30</span><span class="p">:</span>
                    <span class="n">flag2</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">buy_p</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Buy</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">pre_low30</span><span class="p">)</span>
                    <span class="n">buy_p</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">flag1</span><span class="p">,</span> <span class="n">flag2</span><span class="p">,</span> <span class="n">buy_p</span></div>

<div class="viewcode-block" id="Trade.buy_in_min30"><a class="viewcode-back" href="../trade.html#trade.Trade.buy_in_min30">[文档]</a>    <span class="k">def</span> <span class="nf">buy_in_min30</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pre_low</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
        <span class="n">flag1</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否跌破前日线低点，跌破日线前低点，终止买点搜索</span>
        <span class="n">flag2</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否找到买点机会</span>
        <span class="n">begin_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">constant</span><span class="o">.</span><span class="n">MIN30_STR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">constant</span><span class="o">.</span><span class="n">MIN30_STR</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">klist30</span> <span class="o">=</span> <span class="n">loadData_min</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">hlp30_env</span> <span class="o">=</span> <span class="n">HLPointMin</span><span class="p">(</span><span class="n">klist30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">THRESH_30</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cursor</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">)):</span>
            <span class="n">ref_low30</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># 如果要以30min低点作参考， 暂时不需要</span>
            <span class="c1"># # 如果已经有30min级别低点，不能跌破前低</span>
            <span class="c1"># if len(hlp30_env.klist[cursor].lpi):</span>
            <span class="c1">#     ref_low30 = hlp30_env.klist[hlp30_env.klist[cursor].lpi[-1]].low</span>

            <span class="k">if</span> <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">pre_low</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">ref_low30</span><span class="p">):</span>
                <span class="n">flag1</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 买点寻找过程中是否跌破前日线低点或更保守的以30min前低点作为参照</span>
                <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;###`buy_in_min30`，未发现30min买点；&quot;</span>
                       <span class="n">f</span><span class="s2">&quot;失败理由：30min下跌趋势中跌破前日线(或前30min)低点&quot;</span><span class="p">,</span>
                       <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                       <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hlp30_env</span><span class="o">.</span><span class="n">step_hl</span><span class="p">(</span><span class="n">wait_thresh</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">WAIT_30TO5</span><span class="p">)</span> <span class="c1"># step_hl使得cursor增加1，注意减回来</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">hpi</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># printt(f&quot;###`buy_in_min30`，未发现30min买点；&quot;</span>
                    <span class="c1">#        f&quot;失败理由：30min未构成完整趋势&quot;,</span>
                    <span class="c1">#        msg_mode=constant.RunMode.REPORT,</span>
                    <span class="c1">#        global_mode=constant.RUN_MODE)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">hpi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># NOTE:放宽要求，l1-h1-l2-cursor(</span>
                        <span class="c1"># c&gt;h2, l2&gt;l1)模式也承认</span>
                        <span class="k">if</span> <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">high</span> <span class="o">&gt;</span> \
                                <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">hpi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">high</span> <span class="ow">and</span> \
                                <span class="p">(</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">low</span> <span class="o">&gt;</span>
                                 <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">low</span><span class="p">):</span>
                            <span class="n">flag2</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 是否找到符合条件的30min级别买点</span>
                            <span class="c1"># 记录有效（有交易发生）30min高点K对象</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hp30</span> <span class="o">+=</span> \
                                <span class="p">[</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="k">for</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">hlp30_env</span><span class="o">.</span><span class="n">hpi</span><span class="p">]</span>
                            <span class="c1"># 记录有效（有交易发生）30min低点K对象</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lp30</span> <span class="o">+=</span> \
                                <span class="p">[</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="k">for</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">hlp30_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">]</span>
                            <span class="n">stop_p</span> <span class="o">=</span> <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">temp_l</span><span class="p">]</span><span class="o">.</span><span class="n">low</span>
                            <span class="n">stop_p</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">constant</span><span class="o">.</span><span class="n">STOP_P_BUFFER_30</span><span class="p">)</span>
                            <span class="n">buy_p</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Buy</span><span class="p">(</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                              <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="p">,</span>
                                              <span class="n">typ</span><span class="p">,</span>
                                              <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                              <span class="n">stop_p</span><span class="o">=</span><span class="n">stop_p</span>
                                              <span class="p">)</span>
                            <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;###`buy_in_min30`，发现30min买点，买点类型:</span><span class="si">{typ}</span><span class="s2">；&quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;买入理由：30min下跌趋势中突破前30min高点；&quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;止损价格</span><span class="si">{stop_p}</span><span class="s2">-&gt;30min最近低点&quot;</span><span class="p">,</span>
                                   <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                                   <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                            <span class="n">buy_p</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">buy_p</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buy_p</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">trade_info</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                                                    <span class="n">typ</span><span class="p">,</span>
                                                                                    <span class="n">hlp30_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                                                                    <span class="n">buy_p</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                                                                    <span class="n">buy_p</span><span class="o">.</span><span class="n">stop_p</span>
                                                                                    <span class="p">)</span>
                            <span class="k">break</span>
        <span class="k">return</span> <span class="n">flag1</span><span class="p">,</span> <span class="n">flag2</span></div>

<div class="viewcode-block" id="Trade.buy_in_day_s"><a class="viewcode-back" href="../trade.html#trade.Trade.buy_in_day_s">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">buy_in_day_s</span><span class="p">(</span><span class="n">pre_low</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">buy_p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">high</span> <span class="o">&lt;=</span> <span class="n">pre_low</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">constant</span><span class="o">.</span><span class="n">MAX_UPFLOAT</span><span class="p">):</span>
            <span class="n">buy_p</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Buy</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">pre_low</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">buy_p</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">flag</span><span class="p">,</span> <span class="n">buy_p</span></div>

<div class="viewcode-block" id="Trade.buy_in_day"><a class="viewcode-back" href="../trade.html#trade.Trade.buy_in_day">[文档]</a>    <span class="k">def</span> <span class="nf">buy_in_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_p</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        在日线级别上的买入操作需要满足以下条件</span>
<span class="sd">        / 1.30min级别买入失败</span>
<span class="sd">        / 2.日线低点被确认当日K收盘</span>
<span class="sd">        / 3.确认当日K的最高价距离被确认的低点上涨幅度低于阈值</span>
<span class="sd">        :param l_p: 最近被确认日线低点索引</span>
<span class="sd">        :param typ: 卖点类型</span>
<span class="sd">        :return: 是否发生日线买入操作</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否发生买入操作</span>
        <span class="n">l_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">l_p</span><span class="p">]</span><span class="o">.</span><span class="n">low</span>
        <span class="n">l_confirmed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">l_p</span><span class="p">]</span><span class="o">.</span><span class="n">hl_confirmed</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">l_confirmed</span><span class="p">]</span><span class="o">.</span><span class="n">high</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">l_pp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">constant</span><span class="o">.</span><span class="n">MAX_UPFLOAT</span><span class="p">):</span>
            <span class="n">buy_p</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Buy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">l_confirmed</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">l_confirmed</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="p">,</span>
                              <span class="n">typ</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">l_confirmed</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                              <span class="n">l_pp</span><span class="p">)</span>
            <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`buy_in_day`，发现日线级别买点，位置</span><span class="si">{l_confirmed}</span><span class="s2">，买点类型</span><span class="si">{typ}</span><span class="s2">；&quot;</span>
                   <span class="n">f</span><span class="s2">&quot;买入价格</span><span class="si">{self.klist[l_confirmed].close}</span><span class="s2">；&quot;</span>
                   <span class="n">f</span><span class="s2">&quot;买入理由：日线级别低点被确认时上涨幅度未超过阈值；&quot;</span>
                   <span class="n">f</span><span class="s2">&quot;止损价格</span><span class="si">{l_pp}</span><span class="s2">--&gt;被确认日线低点&quot;</span><span class="p">,</span>
                   <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                   <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">buy_p</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">buy_p</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buy_p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">l_confirmed</span><span class="p">]</span><span class="o">.</span><span class="n">trade_info</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                               <span class="n">buy_p</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span>
                                               <span class="n">buy_p</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                                               <span class="n">buy_p</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                               <span class="n">buy_p</span><span class="o">.</span><span class="n">stop_p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`buy_in_day`，未发现日线级别买点；&quot;</span>
                   <span class="n">f</span><span class="s2">&quot;失败理由：日线级别低点被确认时上涨幅度超过阈值&quot;</span><span class="p">,</span>
                   <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                   <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flag</span></div>

<div class="viewcode-block" id="Trade.seek_to_sell"><a class="viewcode-back" href="../trade.html#trade.Trade.seek_to_sell">[文档]</a>    <span class="k">def</span> <span class="nf">seek_to_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        此函数用于寻找卖点</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否发生卖出操作</span>
        <span class="c1"># 如果没有多头仓位，不操作</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 先以日线卖出标准将能够卖出的都卖出</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="p">:</span>
                <span class="n">bb</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># b =(buy object, index in order_l)</span>
                <span class="c1"># 符合日线上止损点或止盈点卖出条件， 注意不能在同一天交易</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&lt;</span> <span class="n">bb</span><span class="o">.</span><span class="n">stop_p</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> \
                        <span class="n">bb</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># 如果是浮盈后离场</span>
                    <span class="k">if</span> <span class="n">bb</span><span class="o">.</span><span class="n">max_profit</span> <span class="o">&gt;</span> <span class="n">constant</span><span class="o">.</span><span class="n">THRESH_PROFIT</span><span class="p">:</span>
                        <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;S3&quot;</span>
                    <span class="c1"># 其他止损点离场</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;S2&quot;</span>
                    <span class="c1"># 创建卖点对象</span>
                    <span class="n">sell_p</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Sell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="p">,</span>
                                        <span class="n">typ</span><span class="p">,</span>
                                        <span class="n">bb</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                        <span class="n">bb</span><span class="p">)</span>
                    <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_sell`，发现卖点，位置</span><span class="si">{self.cursor}</span><span class="s2">；&quot;</span>
                           <span class="n">f</span><span class="s2">&quot;卖点类型</span><span class="si">{typ}</span><span class="s2">，卖出价格</span><span class="si">{self.klist[self.cursor].close}</span><span class="s2">；&quot;</span>
                           <span class="n">f</span><span class="s2">&quot;卖出理由：</span><span class="si">{constant.BUYSELL_TYPE[typ][2]}</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                           <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># 在Account中注册卖点信息</span>
                    <span class="n">sell_p</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sell_p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order_s</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sell_p</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trade_info</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                       <span class="n">typ</span><span class="p">,</span>
                                                       <span class="n">sell_p</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                                                       <span class="n">sell_p</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                                       <span class="kc">None</span>
                                                       <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">low</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bb</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># 不符合上述条件，但是直接跌破前日线低点；一般适用于在日线级别买入后马上跌破</span>
                    <span class="c1"># 或30min低点恰好是日线低点马上跌破的30min买点</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;S1&quot;</span>
                    <span class="n">sell_p</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Sell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="p">,</span>
                                        <span class="n">typ</span><span class="p">,</span>
                                        <span class="n">bb</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                        <span class="n">bb</span><span class="p">)</span>
                    <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_sell`，发现卖点，位置</span><span class="si">{self.cursor}</span><span class="s2">；&quot;</span>
                           <span class="n">f</span><span class="s2">&quot;卖点类型S1，卖出价格</span><span class="si">{self.klist[self.cursor].close}</span><span class="s2">；&quot;</span>
                           <span class="n">f</span><span class="s2">&quot;卖出理由：</span><span class="si">{constant.BUYSELL_TYPE[&#39;S1&#39;][2]}</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                           <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">sell_p</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sell_p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order_s</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sell_p</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trade_info</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                       <span class="n">typ</span><span class="p">,</span>
                                                       <span class="n">sell_p</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                                                       <span class="n">sell_p</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                                       <span class="kc">None</span>
                                                       <span class="p">)</span>
            <span class="c1"># 当日不能以日线卖出的买点，考虑是否需要进行降级别处理</span>
            <span class="c1"># 降级别计算较复杂，主要功能采用一个特别类对象来处理</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trd</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">lev_chg_signal</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="p">:</span>
                        <span class="n">bb</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># 当前时间买点已经发生</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">kti</span> <span class="o">&gt;</span> <span class="n">bb</span><span class="o">.</span><span class="n">index_k</span><span class="o">.</span><span class="n">kti</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="p">:</span>
                                <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">LevChg</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                                          <span class="n">lev</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                          <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">ref_t</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">]</span>
                                                          <span class="p">)</span>
                                <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`sek_to_sell`，发起30min级别卖点寻找，&quot;</span>
                                       <span class="n">f</span><span class="s2">&quot;开始位置</span><span class="si">{self.cursor}</span><span class="s2">&quot;</span><span class="p">,</span>
                                       <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                                       <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">roll_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">end_up_trd</span><span class="p">:</span>
                                    <span class="n">sell_k</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">sell_k</span>
                                    <span class="n">typ</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;S4&quot;</span><span class="p">,</span> <span class="s2">&quot;S5&quot;</span><span class="p">][</span><span class="n">sell_k</span><span class="o">.</span><span class="n">lev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">hp30</span> <span class="o">+=</span> \
                                        <span class="p">[</span><span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="k">for</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">hpi</span><span class="p">]</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">lp30</span> <span class="o">+=</span> \
                                        <span class="p">[</span><span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="k">for</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;S5&quot;</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hp5</span> <span class="o">+=</span> <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">hp5</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">lp5</span> <span class="o">+=</span> <span class="n">bb</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">lp5</span>
                                    <span class="n">sell_p</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">Sell</span><span class="p">(</span><span class="n">sell_k</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                                        <span class="n">sell_k</span><span class="o">.</span><span class="n">i</span><span class="p">,</span>
                                                        <span class="n">typ</span><span class="p">,</span>
                                                        <span class="n">bb</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                                        <span class="n">sell_k</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span>
                                                        <span class="n">bb</span><span class="p">)</span>
                                    <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;##`seek_to_sell`，发现卖点，位置</span><span class="si">{self.cursor}</span><span class="s2">；&quot;</span>
                                           <span class="n">f</span><span class="s2">&quot;卖点类型</span><span class="si">{typ}</span><span class="s2">，卖出价格</span><span class="si">{sell_k.close}</span><span class="s2">；&quot;</span>
                                           <span class="n">f</span><span class="s2">&quot;卖出理由：</span><span class="si">{constant.BUYSELL_TYPE[&#39;S1&#39;][2]}</span><span class="s2">&quot;</span><span class="p">,</span>
                                           <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                                           <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">sell_p</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sell_p</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">order_s</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sell_p</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">trade_info</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                                       <span class="n">typ</span><span class="p">,</span>
                                                                       <span class="n">sell_p</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                                                                       <span class="n">sell_p</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                                                                       <span class="kc">None</span>
                                                                       <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
        <span class="k">return</span> <span class="n">flag</span></div>

<div class="viewcode-block" id="Trade.get_bs"><a class="viewcode-back" href="../trade.html#trade.Trade.get_bs">[文档]</a>    <span class="k">def</span> <span class="nf">get_bs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        寻找买卖点主函数</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">):</span>
            <span class="c1"># 当日是否满足买入条件，发生买入交易</span>
            <span class="n">buy_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seek_to_buy</span><span class="p">()</span>
            <span class="c1"># 对现有买点更新其每笔多头持仓信息</span>
            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="p">:</span>
                <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">)</span>
            <span class="c1"># 当日是否满足卖出条件，发生卖出交易</span>
            <span class="n">sell_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seek_to_sell</span><span class="p">()</span>
            <span class="c1"># 总账户信息刷新</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sum_up</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">)</span>
            <span class="c1"># 在经过卖点判断后，如果还存在未平仓的多头头寸</span>
            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="p">:</span>
                <span class="c1"># 确定每笔多头的操作级别</span>
                <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lev_chg</span><span class="p">:</span>
                    <span class="c1"># 如果监控该买点卖出操作，存在级别转换对象（处于变小操作频率状态），至少操作级别为2（30min及以上）</span>
                    <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">operate_lev</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lev_chg</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="p">:</span>
                        <span class="c1"># 如果该买点的级别转换对象还存在更小级别的频率对象，则当前处于5min操作级别</span>
                        <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">operate_lev</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="c1"># 当前卖点操作级别为所有未平仓买点操作级别最高者</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_sell</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">operate_lev</span> <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_l</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># 当前买卖操作级别为买点操作级别和卖点操作级别孰高</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_buy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operate_lev_sell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Trade.LevChg"><a class="viewcode-back" href="../trade.html#trade.Trade.LevChg">[文档]</a>    <span class="k">class</span> <span class="nc">LevChg</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">lev</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">ref_t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>  <span class="c1"># 股票代码</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lev</span> <span class="o">=</span> <span class="n">lev</span>  <span class="c1"># 本级别，2=30 min or 3=5 min</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 是否有低级别对象，None or LevChg object(expect to be lev=3)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">klist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span> <span class="o">=</span> <span class="n">ref_t</span>  <span class="c1"># 上一级别的的K对象，为确定进入本级别的后一个上级别单位</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 高低点操作对象</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_up_trd</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sell_k</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 可能出现的卖点K线</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_klist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp5</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lp5</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Trade.LevChg.init_klist"><a class="viewcode-back" href="../trade.html#trade.Trade.LevChg.init_klist">[文档]</a>        <span class="k">def</span> <span class="nf">init_klist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">kti</span>
                <span class="n">begin_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">constant</span><span class="o">.</span><span class="n">MIN30_STR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">kti_seq</span> <span class="o">=</span> <span class="n">get_kti_seq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">LEN_K30</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">),</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_30</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_5</span><span class="p">)</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">kti_seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span>
                           <span class="n">constant</span><span class="o">.</span><span class="n">MIN30_STR</span><span class="p">[</span><span class="n">kti_seq</span><span class="p">[</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="s2">&quot;15:00:00&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">klist</span> <span class="o">=</span> <span class="n">loadData_min</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span> <span class="o">=</span> <span class="n">HLPointMin</span><span class="p">(</span><span class="n">klist_m</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">,</span>
                                          <span class="n">code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                          <span class="n">thresh</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">THRESH_30</span><span class="p">,</span>
                                          <span class="n">k_lev</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                          <span class="n">init_hl</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">)</span>  <span class="c1"># 默认寻找高点</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">kti</span>
                <span class="n">begin_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> \
                             <span class="nb">min</span><span class="p">(</span><span class="n">constant</span><span class="o">.</span><span class="n">MIN5_STR</span><span class="p">[</span><span class="n">t2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;15:00:00&quot;</span><span class="p">)</span>
                <span class="n">kti_seq</span> <span class="o">=</span> <span class="n">get_kti_seq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">LEN_K5</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t3</span><span class="p">),</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_30</span><span class="p">,</span> <span class="n">constant</span><span class="o">.</span><span class="n">N_5</span><span class="p">)</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">kti_seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span>
                           <span class="n">constant</span><span class="o">.</span><span class="n">MIN5_STR</span><span class="p">[</span>
                    <span class="n">kti_seq</span><span class="p">[</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span>
                    <span class="n">kti_seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">kti</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="s2">&quot;15:00:00&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">klist</span> <span class="o">=</span> <span class="n">loadData_min</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span> <span class="o">=</span> <span class="n">HLPointMin</span><span class="p">(</span><span class="n">klist_m</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">,</span>
                                          <span class="n">code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                          <span class="n">thresh</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">THRESH_5</span><span class="p">,</span>
                                          <span class="n">k_lev</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                          <span class="n">init_hl</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Trade.LevChg.roll_forward"><a class="viewcode-back" href="../trade.html#trade.Trade.LevChg.roll_forward">[文档]</a>        <span class="k">def</span> <span class="nf">roll_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lev_higher</span><span class="p">):</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">lev_higher</span><span class="o">.</span><span class="n">i</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">step_hl</span><span class="p">(</span><span class="n">wait_thresh</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">WAIT_30TO5</span><span class="p">)</span>  <span class="c1"># step_hl操作会使cursor向后推</span>
                <span class="c1"># 如果有同时在进行的低级别过程</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="o">.</span><span class="n">roll_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="o">.</span><span class="n">end_up_trd</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">end_up_trd</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;###`roll_forward`，30min-&gt;5min级别下上涨趋势结束，&quot;</span>
                               <span class="n">f</span><span class="s2">&quot;位置</span><span class="si">{lev_higher.i.kti}</span><span class="s2">&quot;</span><span class="p">,</span>
                               <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                               <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sell_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="o">.</span><span class="n">sell_k</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hp5</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="k">for</span>
                                    <span class="n">cur</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">hpi</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lp5</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="k">for</span>
                                    <span class="n">cur</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="c1"># 没有更低级别的进程</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 是否满足本级别终止条件</span>
                    <span class="c1"># 如果当前级别至少有一个低点</span>
                    <span class="c1"># 由于默认应当已经在上涨趋势，一旦跌破前低就认为是结束本级别上涨趋势</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">low</span> <span class="o">&lt;</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">lpi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end_up_trd</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sell_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;###`roll_forward`，&quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;{[&#39;30min&#39;, &#39;5min&#39;][self.lev-2]}级别下上涨趋势结束，&quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;位置</span><span class="si">{lev_higher.i.kti}</span><span class="s2">，发出卖点信号&quot;</span><span class="p">,</span>
                                   <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                                   <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="c1"># 不满足本级别终止条件，是否需要进入低接别</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lev</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lev_chg_signal</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lev_chg_lower</span> <span class="o">=</span> <span class="n">Trade</span><span class="o">.</span><span class="n">LevChg</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                                          <span class="n">lev</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                          <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span><span class="p">],</span>
                                                          <span class="n">ref_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">)</span>
                        <span class="n">printt</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;###`roll_forward`，&quot;</span>
                               <span class="n">f</span><span class="s2">&quot;由30min操作级别转入5min操作级别寻找卖点，&quot;</span>
                               <span class="n">f</span><span class="s2">&quot;位置</span><span class="si">{lev_higher.i.kti}</span><span class="s2">&quot;</span><span class="p">,</span>
                               <span class="n">msg_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RunMode</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span>
                               <span class="n">global_mode</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">RUN_MODE</span><span class="p">)</span>
            <span class="c1"># 完成本轮循环，说明本级别过程仍然继续，需要考虑扩充本级别序列的数据</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klist</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">cursor</span> <span class="o">&lt;=</span> <span class="p">[</span><span class="n">constant</span><span class="o">.</span><span class="n">LEN_K5</span><span class="o">*</span><span class="mf">0.25</span><span class="p">,</span>
                                                         <span class="n">constant</span><span class="o">.</span><span class="n">LEN_K30</span><span class="o">*</span><span class="mf">0.25</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">lev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hlp_env</span><span class="o">.</span><span class="n">extend_klist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_t</span><span class="p">)</span></div></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>









</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">模块代码</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Maggie Hu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>